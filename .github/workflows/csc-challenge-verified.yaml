name: On Challenge Verified
on:
  issue_comment:
    types:
    - created

permissions:
  contents: read
  id-token: write
  issues: write

jobs:
  verification-completion:
    name: Completing verification
    runs-on: ubuntu-latest

    steps:
    - name: Check challenge code
      id: challenge
      shell: pwsh
      run: |
        $title = "${{ github.event.issue.title }}"
        $code = $title.Contains("]") ? $title.Substring(0, $title.IndexOf(']')).Replace("[", "").Replace("]", "").Trim().ToLowerInvariant() : ""
        $codeUpper = ($code -ne "") ? $code.ToUpperInvariant() : ""
        $codes = @("az-900", "ai-900", "dp-900", "pl-900", "sc-900", "ms-900")
        $isValidCode = ($code -ne "") ? $($codes.Contains($code)).ToString().ToLowerInvariant() : $false

        echo "code=$code" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf-8 -Append
        echo "codeUpper=$codeUpper" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf-8 -Append
        echo "isValidCode=$isValidCode" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf-8 -Append

    - name: Call Power Automate workflow
      if: |
        github.event.comment.user.login == github.event.issue.assignee.login &&
        steps.challenge.outputs.isValidCode == 'true' &&
        contains(github.event.comment.body, '/ok')
      uses: fjogeleit/http-request-action@v1
      with:
        url: ${{ secrets.PAU_ON_CHALLENGE_VERIFIED_URL }}
        method: 'POST'
        data: '{ "githubId": "${{ github.event.issue.user.login }}", "challengeCode": "${{ steps.challenge.outputs.codeUpper }}" }'

    - name: Remove label
      if: |
        github.event.comment.user.login == github.event.issue.assignee.login &&
        contains(github.event.comment.body, '/ok')
      uses: buildsville/add-remove-label@v2.0.0
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        labels: verifying
        type: remove

    - name: Aadd label
      if: |
        github.event.comment.user.login == github.event.issue.assignee.login &&
        contains(github.event.comment.body, '/ok')
      uses: buildsville/add-remove-label@v2.0.0
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        labels: verified
        type: add

    - name: Post message to Discord
      if: |
        github.event.comment.user.login == github.event.issue.assignee.login &&
        steps.challenge.outputs.isValidCode == 'true' &&
        contains(github.event.comment.body, '/ok')
      uses: Ilshidur/action-discord@master
      env:
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
      with:
        args: 'GitHub ID @${{ github.event.issue.user.login }}ë‹˜ê»˜ì„œ ${{ steps.challenge.outputs.codeUpper }} ê³¼ì •ì„ ë‹¬ì„±í•˜ì…¨ìŠµë‹ˆë‹¤.'

    - name: Comment and close Issue
      if: |
        github.event.comment.user.login == github.event.issue.assignee.login &&
        contains(github.event.comment.body, '/ok')
      uses: peter-evans/close-issue@v3
      with:
        comment: |
          ì¶•í•˜ë“œë¦½ë‹ˆë‹¤, @${{ github.event.issue.user.login }}ë‹˜!

          ${{ steps.challenge.outputs.codeUpper }} ê³¼ì •ì„ ëë‚´ì„œ ìˆ˜ê³ í–ˆë‹¤ëŠ” ë§ì”€ ë“œë¦¬ê³  ì‹¶ì–´ìš”!

          ${{ steps.challenge.outputs.codeUpper }} ê³¼ì •ì„ ë§ˆì¹˜ê³  ëŠë‚€ ê°ì •ì´ë‚˜ ì–´ë ¤ì› ë˜ ì ì„ ê³µìœ í•´ì£¼ì‹œë©´ ë”ìš± ì¢‹ê² ì–´ìš”.

          ì•ìœ¼ë¡œë„ í™”ì´íŒ…í•˜ì„¸ìš”! ğŸ‰ğŸ‰ğŸ‰ğŸ’ªğŸ’ªğŸ’ª