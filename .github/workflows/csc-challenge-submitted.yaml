name: On Challenge Submitted

on:
  issues:
    types:
    - opened

permissions:
  contents: read
  id-token: write
  issues: write

jobs:
  labelling:
    name: 'Add a label on submission: review-required'

    runs-on: ubuntu-latest

    steps:
    - name: Check issue date/time
      id: checkpoint
      shell: pwsh
      run: |
        $tz = [TimeZoneInfo]::FindSystemTimeZoneById("Asia/Seoul")
        $dateSubmitted = [DateTimeOffset]::Parse("${{ github.event.issue.created_at }}")
        $offset = $tz.GetUtcOffset($dateSubmitted)

        $dateSubmitted = $dateSubmitted.ToOffset($offset)
        $dateDue = $([DateTimeOffset]::Parse("${{ vars.CSC_DUE_DATE }}"))
        $isOverdue = "$($dateSubmitted -gt $dateDue)".ToLowerInvariant()

        $dateSubmittedValue = $dateSubmitted.ToString("yyyy-MM-ddTHH:mm:ss.fffzzz")
        $dateDueValue = $dateDue.ToString("yyyy-MM-ddTHH:mm:ss.fffzzz")

        echo "dateSubmitted=$dateSubmittedValue" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf-8 -Append
        echo "dateDue=$dateDueValue" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf-8 -Append
        echo "isOverdue=$isOverdue" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf-8 -Append

    - name: Check challenge code
      id: challenge
      shell: pwsh
      run: |
        $title = "${{ github.event.issue.title }}"
        $code = $title.Contains("]") ? $title.Substring(0, $title.IndexOf(']')).Replace("[", "").Replace("]", "").Trim().ToLowerInvariant() : ""
        $codeUpper = ($code -ne "") ? $code.ToUpperInvariant() : ""
        $codes = @("az-900", "ai-900", "dp-900", "pl-900", "sc-900", "ms-900")
        $isValidCode = ($code -ne "") ? $($codes.Contains($code)).ToString().ToLowerInvariant() : $false

        echo "code=$code" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf-8 -Append
        echo "codeUpper=$codeUpper" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf-8 -Append
        echo "isValidCode=$isValidCode" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf-8 -Append

    - name: Add a label - Overdue
      if: ${{ steps.checkpoint.outputs.isOverdue == 'true' }}
      shell: bash
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh issue edit ${{ github.event.issue.number }} \
          --add-label "overdue" \
          -R ${{ github.event.repository.full_name }}

    - name: Comment to issue - Overdue
      if: ${{ steps.checkpoint.outputs.isOverdue == 'true' }}
      uses: bubkoo/auto-comment@v1
      with:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        issuesOpened: |
          ğŸ‘‹ğŸ¼ @{{ author }} ë‹˜!

          * ì´ìŠˆ ì œì¶œ ì‹œê°: ${{ steps.checkpoint.outputs.dateSubmitted }}
          * ì´ìŠˆ ë§ˆê° ì‹œê°: ${{ steps.checkpoint.outputs.dateDue }}

          ì•ˆíƒ€ê¹ê²Œë„ ì œì¶œí•˜ì‹  ì´ìŠˆëŠ” ë§ˆê° ê¸°í•œì¸ ${{ steps.checkpoint.outputs.dateDue }}ì„ ë„˜ê¸°ì…¨ìŠµë‹ˆë‹¤. ğŸ˜­ ë”°ë¼ì„œ, ì´ë²ˆ í´ë¼ìš°ë“œ ìŠ¤í‚¬ ì±Œë¦°ì§€ ì´ë²¤íŠ¸ì— ë°˜ì˜ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

          ê·¸ë™ì•ˆ í´ë¼ìš°ë“œ ìŠ¤í‚¬ ì±Œë¦°ì§€ ì´ë²¤íŠ¸ì— ì°¸ì—¬í•´ ì£¼ì…”ì„œ ê°ì‚¬ ë“œë¦½ë‹ˆë‹¤. í•˜ì§€ë§Œ ìš°ë¦¬ëŠ” í•´ì»¤í†¤ì´ ìˆì–ì•„ìš”? ê±°ê¸°ì„œ ë‹¤ì‹œ ë§Œë‚˜ìš”!

    - name: Close issue - Overdue
      if: ${{ steps.checkpoint.outputs.isOverdue == 'true' }}
      shell: bash
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh issue close ${{ github.event.issue.number }} \
          -c "ì±Œë¦°ì§€ ì œì¶œ ê¸°í•œì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì´ìŠˆë¥¼ ë‹«ìŠµë‹ˆë‹¤." \
          -R ${{ github.event.repository.full_name }}

    - name: Add a label - Invalid challenge code
      if: ${{ steps.checkpoint.outputs.isOverdue == 'false' && steps.challenge.outputs.isValidCode == 'false' }}
      shell: bash
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh issue edit ${{ github.event.issue.number }} \
          --add-label "invalid" \
          -R ${{ github.event.repository.full_name }}
  
    - name: Comment to issue - Invalid challenge code
      if: ${{ steps.checkpoint.outputs.isOverdue == 'false' && steps.challenge.outputs.isValidCode == 'false' }}
      uses: bubkoo/auto-comment@v1
      with:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        issuesOpened: |
          ğŸ‘‹ğŸ¼ @{{ author }} ë‹˜!

          * ì œì¶œ ì±Œë¦°ì§€ ì½”ë“œ: `${{ steps.challenge.outputs.codeUpper }}`
          * ì˜ˆìƒ ì±Œë¦°ì§€ ì½”ë“œ: `AZ-900`, `AI-900`, `DP-900`, `PL-900`, `SC-900`, `MS-900`

          ì•ˆíƒ€ê¹ê²Œë„ ì œì¶œí•˜ì‹  ì´ìŠˆëŠ” ì •í™•í•œ ì±Œë¦°ì§€ ì½”ë“œê°€ ì œëª©ì— í¬í•¨ë˜ì–´ ìˆì§€ ì•Šì•„ í™•ì¸ì„ í•  ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤. ğŸ˜± ì±Œë¦°ì§€ ì½”ë“œëŠ” ìœ„ì— ì–¸ê¸‰í•œ ì—¬ì„¯ ê°€ì§€ ì¤‘ í•˜ë‚˜ì—¬ì•¼ í•©ë‹ˆë‹¤.

          ì´ ì´ìŠˆëŠ” ìë™ìœ¼ë¡œ ë‹«í ì˜ˆì •ì´ë‹ˆ, ìƒˆë¡­ê²Œ ì´ìŠˆë¥¼ ìƒì„±í•´ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.
  
    - name: Close issue - Invalid challenge code
      if: ${{ steps.checkpoint.outputs.isOverdue == 'false' && steps.challenge.outputs.isValidCode == 'false' }}
      shell: bash
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh issue close ${{ github.event.issue.number }} \
          -c "ì±Œë¦°ì§€ ì½”ë“œë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì´ìŠˆë¥¼ ë‹«ìŠµë‹ˆë‹¤." \
          -R ${{ github.event.repository.full_name }}
  
    - name: Add a label - Acknowledge
      if: ${{ steps.checkpoint.outputs.isOverdue == 'false' && steps.challenge.outputs.isValidCode == 'true' }}
      shell: bash
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh issue edit ${{ github.event.issue.number }} \
          --add-label "csc,${{ steps.challenge.outputs.code }},verifying" \
          -R ${{ github.event.repository.full_name }}

    - name: Get random assignee
      if: ${{ steps.checkpoint.outputs.isOverdue == 'false' && steps.challenge.outputs.isValidCode == 'true' }}
      id: assignee
      shell: pwsh
      run: |
        $scriptUrl = "https://raw.githubusercontent.com/hackersground-kr/operations/main/get-randomassignee/Get-RandomAssignee.ps1"
        Invoke-RestMethod $scriptUrl | Out-File ~/Get-RandomAssignee.ps1
        $assignee = $(~/Get-RandomAssignee.ps1 -Assignees "${{ secrets.INSPECTORS }}")

        echo "value=$assignee" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf-8 -Append

    - name: Assign a staff
      if: ${{ steps.checkpoint.outputs.isOverdue == 'false' && steps.challenge.outputs.isValidCode == 'true' }}
      shell: bash
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh issue edit ${{ github.event.issue.number }} \
          --add-assignee "${{ steps.assignee.outputs.value }}" \
          -R ${{ github.event.repository.full_name }}

    - name: Comment to issue - Acknowledge
      if: ${{ steps.checkpoint.outputs.isOverdue == 'false' && steps.challenge.outputs.isValidCode == 'true' }}
      uses: bubkoo/auto-comment@v1
      with:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        issuesOpenedReactions: 'rocket, +1'
        issuesOpened: |
          ğŸ‘‹ğŸ¼ @{{ author }} ë‹˜!

          ${{ steps.challenge.outputs.codeUpper }} ì±Œë¦°ì§€ ì™„ë£Œ ì´ìŠˆë¥¼ ìƒì„±í•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤! ğŸ‰ ì°¸ê°€ìë‹˜ì˜ í•´ì»¤í†¤ ì™„ì£¼ë¥¼ ì‘ì›í•´ìš”! ğŸ’ªğŸ¼

          @${{ steps.assignee.outputs.value }} ë‹˜ê»˜ì„œ ìµœëŒ€í•œ ë¹ ë¥´ê²Œ í™•ì¸í•´ ë“œë¦¬ê² ìŠµë‹ˆë‹¤! ğŸ˜Š

          ğŸ”¹ í•´ì»¤ê·¸ë¼ìš´ë“œ ìš´ì˜ì§„ ì¼ë™ ğŸ”¹
